version: '3.9'

services:
  server:
    build:
      context: ./server
      dockerfile: Dockerfile.prod
    image: codex-server:prod
    environment:
      NODE_ENV: production
      PORT: ${SERVER_PORT:-4000}
      DATABASE_URL: ${DATABASE_URL:-file:/app/prisma/dev.db}
    volumes:
      - sqlite_data:/app/prisma
      - uploads_data:/app/uploads
    ports:
      - '${SERVER_PORT:-4000}:4000'
    healthcheck:
      test: ['CMD', 'curl', '-fsS', 'http://localhost:4000/healthz']
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
        labels: 'service'
    restart: unless-stopped

  web:
    build:
      context: ./client
      dockerfile: Dockerfile.prod
    image: codex-client:prod
    environment:
      NEXT_PUBLIC_API_ENDPOINT: ${NEXT_PUBLIC_API_ENDPOINT:-http://localhost:4000}
      NEXT_PUBLIC_URL: ${NEXT_PUBLIC_URL:-http://localhost:3000}
    depends_on:
      server:
        condition: service_healthy
    ports:
      - '${CLIENT_PORT:-3000}:3000'
    healthcheck:
      test: ['CMD', 'wget', '-qO-', 'http://localhost:3000/healthz']
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
        labels: 'service'
    restart: unless-stopped

volumes:
  sqlite_data:
  uploads_data:
